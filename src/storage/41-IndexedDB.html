<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>indexedDB 索引</title>
</head>
<body>
    <script>

        // Every borwsers
        window.indexedDB = window.indexedDB || window.mozIndexedDB 
        || window.webkitIndexedDB || window.msIndexedDB;
        window.IDBTransaction = window.IDBTransaction 
        || window.webkitIDBTransaction || msIDBTransaction;
        window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange 
        || window.msIDBKeyRange; 
        window.IDBCursor = window.IDBCursor || window.webkitIDBCursor 
        || window.msIDBCursor;

        var myDB = {
            name:"helloindexDB",
            version:1,
            db:null
        };


        /////////////////////////////
        // create store
        function openDB(name, version){
            var version = version || 1;
            var request = window.indexedDB.open(name, version);

            request.onsuccess = function(e){
                myDB.db = e.target.result;
                console.log("Database connection successed!");
            };

            request.onerror = function (){
                console.log("Database connection fail!");
            };

            request.onupgradeneeded = function(e){
                var db = e.target.result
                if(!db.objectStoreNames.contains("students")){

                    var store = db.createObjectStore("students",
                        {keyPath: "id"});
                        // 创建主键/索引

                    store.createIndex("nameIndex", "name", {unique: true});
                    // unique: true: 唯一
                    store.createIndex("ageIndex", "age", {unique: false});
                    console.log("create store student");
                }
            }     
        }


        //////////////////////////
        // test Data
        var students =[{
            id:101,
            name:"aa",
            age:10
        },{
            id: 102,
            name: "bb",
            age: 11
        },{
            id: 103,
            name: "cc",
            age: 11
        },{
            id: 104,
            name: "dd",
            age: 13
        },{
            id: 105,
            name: "ee",
            age: 11
        }];


        ////////////////////////////////
        // 添加
        function addData(db, storeName){
            var transaction = db.transaction(storeName, "readwrite");
            // 可读,可写

            var store = transaction.objectStore(storeName);
            
            for(var i = 0; i < students.length; i++){
                //console.log(students[i]);                    
                store.add(students[i]);
                // add array
            }
        }
    
        openDB(myDB.name, myDB.version);
        
        // 
        setTimeout( function(){
            addData(myDB.db, "students");
            //DB conn,  DB name
        }, 1000);


        /////////////////////////////
        // name index
        function getDataByIndexName(db, storeName){
            var transaction = db.transaction(storeName);
            var store = transaction.objectStore(storeName);
            var index = store.index("nameIndex");
            index.get("name01").onsuccess = function(e){
                var students = e.target.result;
//                console.log(students.name + "--" + students.age + "--" 
//                + students.id );
            }
        }

        setTimeout(function(){
            getDataByIndexName(myDB.db, "students");
        }, 1000);


        /////////////////////////////
        // age index
        function DataByIndexName(db, storeName){
            var transaction = db.transaction(storeName);
            var store = transaction.objectStore(storeName);
            var index = store.index("ageIndex");
            index.get(11).onsuccess = function(e){
                var student = e.target.result;
//                console.log("姓名: "+ student.name + " - 年龄:" + student.age);
            }
        }

        setTimeout(function(){
           DataByIndexName(myDB.db, "students"); 
       }, 1000);


       //////////////////////////////////
       // 游标
       //
       function fetchStoreByCursor(db, storeName){
            var transaction = db.transaction(storeName);
            var store = transaction.objectStore(storeName);
            var request = store.openCursor();
            request.onsuccess = function(e){
                var cursor = e.target.result;
                if(cursor){
//                    console.log(cursor.key);//主键
                    var currentStudent = cursor.value;
                    //游标值
                    console.log(currentStudent.name);
                    cursor.continue(); 
                    //游标下移, 无时返回undefine
                }
            }
        }

        setTimeout(function(){
            fetchStoreByCursor(myDB.db, "students");
        }, 1000);

        /////////////////////////////
        // index 与 cursor 配合
        // Has Bug
        function getData(db, storeName){
            var transaction = db.transaction(storeName);
            var store = transaction.objectStore(storeName);
            var index = store.index("ageIndex");
            var request = index.openCursor(IDBKeyRange.only(11));
            request.onsuccess = function(e){
                var cursor = e.target.result;
                if(cursor){
                    var student = cursor.value;
                    console.log(student.id);
                    cursor.continue();
                }
            }
        }

        setTimeout(function(){
            getData(myDB.db, "students");
        }, 1000);

        /////////////////////////////
        // openCursor 范围
        function getDatafanwei(db, storeName){
            var transaction = db.transaction(storeName);
            var store = transaction.objectStore(storeName);
            var index = store.index("nameIndex");
            // IDBKeyRange.only(value): 只获取指定数据
            // IDBKeyRange.lowerBuund(value, isOpen): 获取最小是value, 
            // 第二参数用来指定是否排除value本身
            // IDBKeyRange.upperBound(value, isOpen):
            // IDBKeyRange.bound(value1, value2, isOpen1, isOpen2):
            var request = index.openCursor(IDBKeyRange.bound("b", "z", false, true));
            request.onsuccess = function(e){
                var cursor = e.target.result;
                if(cursor){
                    var student = cursor.value;
                    console.log(student.id);
                    cursor.continue();
                }
            }
        }

    </script>
</body>
</html>
